Lorimer | 2024-08-26 21:02:32 UTC | #1

This topic is intended to capture Subnet Management activities over time for the [4zbus](https://dashboard.internetcomputer.org/subnet/4zbus-z2bmt-ilreg-xakz4-6tyre-hsqj4-slb4g-zjwqo-snjcc-iqphi-3qe) subnet, providing a place to ask questions and make observations about the management of this subnet.

At the time of creating this topic the current subnet configuration is as follows:

<details>
  <summary>Expand</summary>

```json
{
  "version": 44581,
  "records": [
    {
      "key": "subnet_record_4zbus-z2bmt-ilreg-xakz4-6tyre-hsqj4-slb4g-zjwqo-snjcc-iqphi-3qe",
      "version": 44581,
      "value": {
        "membership": [
          "najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae",
          "oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae",
          "75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae",
          "ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae",
          "cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae",
          "5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe",
          "7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae",
          "v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae",
          "c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe",
          "nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe",
          "uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae",
          "jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae",
          "7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe"
        ],
        "nodes": {},
        "max_ingress_bytes_per_message": 2097152,
        "max_ingress_messages_per_block": 1000,
        "max_block_payload_size": 4194304,
        "unit_delay_millis": 1000,
        "initial_notary_delay_millis": 600,
        "replica_version_id": "3d0b3f10417fc6708e8b5d844a0bac5e86f3e17d",
        "dkg_interval_length": 499,
        "start_as_nns": false,
        "subnet_type": "verified_application",
        "features": {
          "canister_sandboxing": false,
          "http_requests": false,
          "sev_enabled": false
        },
        "max_number_of_canisters": 120000,
        "ssh_readonly_access": [],
        "ssh_backup_access": [],
        "ecdsa_config": null,
        "chain_key_config": null
      }
    }
  ]
}
```

</details>

-------------------------

Lorimer | 2024-08-09 23:01:42 UTC | #2

There’s an open proposal for changing subnet membership - https://dashboard.internetcomputer.org/proposal/131705. This information is presented below:

 - red marker represents a removed node (transparent center for overlap visibility)
 - green marker represents an added node
 - blue marker represents an unchanged node
 - highlighted patches represent the country a node sits within (red if the country is removed, green if added, otherwise grey)

![image|690x221](upload://mGFuKcmgkAtJSSltUxeNHMXBzH7.jpeg)


<details>
    <summary>Table</summary>

|   |Country|Data Center|Owner|Node Provider|Node|Status|
|---|-------|-----------|-----|-------------|----|------|
|`---`|~~Japan~~|[~~Tokyo 3 (ty3)~~](https://dashboard.internetcomputer.org/center/ty3)|~~Equinix~~|[~~Starbase~~](https://dashboard.internetcomputer.org/provider/sixix-2nyqd-t2k2v-vlsyz-dssko-ls4hl-hyij4-y7mdp-ja6cj-nsmpf-yae)|[~~nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe~~](https://dashboard.internetcomputer.org/node/nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe)|[~~DOWN~~](https://dashboard.internetcomputer.org/node/nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe)|
|`---`|~~United States of America (the)~~|[~~Jacksonville (jv1)~~](https://dashboard.internetcomputer.org/center/jv1)|~~Tierpoint~~|[~~9Yards Capital~~](https://dashboard.internetcomputer.org/provider/spp3m-vawt7-3gyh6-pjz5d-6zidf-up3qb-yte62-otexv-vfpqg-n6awf-lqe)|[~~7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae~~](https://dashboard.internetcomputer.org/node/7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae)|[~~UP~~](https://dashboard.internetcomputer.org/node/7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae)|
|`+++`|Germany|[Munich (mu1)](https://dashboard.internetcomputer.org/center/mu1)|q.beyond|[Staking Facilities](https://dashboard.internetcomputer.org/provider/niw4y-easue-l3qvz-sozsi-tfkvb-cxcx6-pzslg-5dqld-ooudp-hsuui-xae)|[yeark-e7nqu-ovf7r-vrjm3-zh7yz-kg6f6-6rlhc-o5kgs-lkriq-5d2hi-zqe](https://dashboard.internetcomputer.org/node/yeark-e7nqu-ovf7r-vrjm3-zh7yz-kg6f6-6rlhc-o5kgs-lkriq-5d2hi-zqe)|[UNASSIGNED](https://dashboard.internetcomputer.org/node/yeark-e7nqu-ovf7r-vrjm3-zh7yz-kg6f6-6rlhc-o5kgs-lkriq-5d2hi-zqe)|
|`+++`|Japan|[Tokyo 2 (ty2)](https://dashboard.internetcomputer.org/center/ty2)|Equinix|[Starbase](https://dashboard.internetcomputer.org/provider/sixix-2nyqd-t2k2v-vlsyz-dssko-ls4hl-hyij4-y7mdp-ja6cj-nsmpf-yae)|[krwx5-u5srm-kqbyx-szogs-gaseq-qzef4-txjmy-ql5em-k6q5n-h3ono-bae](https://dashboard.internetcomputer.org/node/krwx5-u5srm-kqbyx-szogs-gaseq-qzef4-txjmy-ql5em-k6q5n-h3ono-bae)|[UNASSIGNED](https://dashboard.internetcomputer.org/node/krwx5-u5srm-kqbyx-szogs-gaseq-qzef4-txjmy-ql5em-k6q5n-h3ono-bae)|
|     |Belgium|[Brussels 2 (br2)](https://dashboard.internetcomputer.org/center/br2)|AtlasEdge|[Allusion](https://dashboard.internetcomputer.org/provider/rbn2y-6vfsb-gv35j-4cyvy-pzbdu-e5aum-jzjg6-5b4n5-vuguf-ycubq-zae)|[najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae](https://dashboard.internetcomputer.org/node/najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae)|[UP](https://dashboard.internetcomputer.org/node/najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae)|
|     |Switzerland|[Geneva 2 (ge2)](https://dashboard.internetcomputer.org/center/ge2)|SafeHost|[Archery Blockchain SCSp](https://dashboard.internetcomputer.org/provider/7ryes-jnj73-bsyu4-lo6h7-lbxk5-x4ien-lylws-5qwzl-hxd5f-xjh3w-mqe)|[uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae](https://dashboard.internetcomputer.org/node/uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae)|[UP](https://dashboard.internetcomputer.org/node/uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae)|
|     |Switzerland|[Zurich 5 (zh5)](https://dashboard.internetcomputer.org/center/zh5)|Green.ch|[Sygnum Bank](https://dashboard.internetcomputer.org/provider/6r5lw-l7db7-uwixn-iw5en-yy55y-ilbtq-e6gcv-g22r2-j3g6q-y37jk-jqe)|[c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe](https://dashboard.internetcomputer.org/node/c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe)|[UP](https://dashboard.internetcomputer.org/node/c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe)|
|     |Spain|[Madrid 3 (ma3)](https://dashboard.internetcomputer.org/center/ma3)|IPCore|[Vladyslav Popov](https://dashboard.internetcomputer.org/provider/3oqw6-vmpk2-mlwlx-52z5x-e3p7u-fjlcw-yxc34-lf2zq-6ub2f-v63hk-lae)|[oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae](https://dashboard.internetcomputer.org/node/oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae)|[UP](https://dashboard.internetcomputer.org/node/oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae)|
|     |Romania|[Bucharest (bu1)](https://dashboard.internetcomputer.org/center/bu1)|M247 |[Iancu Aurel](https://dashboard.internetcomputer.org/provider/i7dto-bgkj2-xo5dx-cyrb7-zkk5y-q46eh-gz6iq-qkgyc-w4qte-scgtb-6ae)|[7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe](https://dashboard.internetcomputer.org/node/7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe)|[UP](https://dashboard.internetcomputer.org/node/7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe)|
|     |Singapore|[Singapore (sg1)](https://dashboard.internetcomputer.org/center/sg1)|Telin|[OneSixtyTwo Digital Capital](https://dashboard.internetcomputer.org/provider/6nbcy-kprg6-ax3db-kh3cz-7jllk-oceyh-jznhs-riguq-fvk6z-6tsds-rqe)|[jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae](https://dashboard.internetcomputer.org/node/jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae)|[UP](https://dashboard.internetcomputer.org/node/jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae)|
|     |Slovenia|[Ljubljana 2 (lj2)](https://dashboard.internetcomputer.org/center/lj2)|Anonstake|[Anonstake](https://dashboard.internetcomputer.org/provider/kos24-5xact-6aror-uofg2-tnvt6-dq3bk-c2c5z-jtptt-jbqvc-lmegy-qae)|[5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe](https://dashboard.internetcomputer.org/node/5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe)|[UP](https://dashboard.internetcomputer.org/node/5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe)|
|     |Sweden|[Stockholm 1 (sh1)](https://dashboard.internetcomputer.org/center/sh1)|Digital Realty|[DFINITY Operations SA](https://dashboard.internetcomputer.org/provider/bvcsg-3od6r-jnydw-eysln-aql7w-td5zn-ay5m6-sibd2-jzojt-anwag-mqe)|[ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae](https://dashboard.internetcomputer.org/node/ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae)|[UP](https://dashboard.internetcomputer.org/node/ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae)|
|     |United States of America (the)|[Atlanta 2 (at2)](https://dashboard.internetcomputer.org/center/at2)|Datasite|[BLP22, LLC](https://dashboard.internetcomputer.org/provider/sma3p-ivkif-hz7nu-ngmvq-ibnjg-nubke-zf6gh-wbnfc-2dlng-l3die-zqe)|[cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae](https://dashboard.internetcomputer.org/node/cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae)|[UP](https://dashboard.internetcomputer.org/node/cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae)|
|     |United States of America (the)|[Fremont (fm1)](https://dashboard.internetcomputer.org/center/fm1)|Hurricane Electric|[Mostly Wholesome, Inc.](https://dashboard.internetcomputer.org/provider/ou3o7-akyjc-ldwd5-anyjn-l2buz-cwhbg-nehlc-abkde-qtc7w-fozdi-hae)|[75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae](https://dashboard.internetcomputer.org/node/75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae)|[UP](https://dashboard.internetcomputer.org/node/75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae)|
|     |United States of America (the)|[Portland (pl1)](https://dashboard.internetcomputer.org/center/pl1)|Flexential|[87m Neuron, LLC](https://dashboard.internetcomputer.org/provider/eipr5-izbom-neyqh-s3ec2-52eww-cyfpg-qfomg-3dpwj-4pffh-34xcu-7qe)|[v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae](https://dashboard.internetcomputer.org/node/v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae)|[UP](https://dashboard.internetcomputer.org/node/v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae)|

</details>

The proposal summary states:

> Motivation: replacing 1 unhealthy node; replacing 1 node to improve subnet decentralization

The unhealthy node refers to [nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe](https://dashboard.internetcomputer.org/node/nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe) which is **down**. It's replaced by another node ([krwx5-u5srm-kqbyx-szogs-gaseq-qzef4-txjmy-ql5em-k6q5n-h3ono-bae](https://dashboard.internetcomputer.org/node/krwx5-u5srm-kqbyx-szogs-gaseq-qzef4-txjmy-ql5em-k6q5n-h3ono-bae)) in the same data center (currently **unassigned**). 👍

The other node that's being replaced appears healthy, and the described rationale is to improve subnet decentralisation. I don't think it's clear how this is achieved by the proposed node change. There are currently 4 nodes located in the US, and 6 nodes in Europe. This proposal removes one of the US nodes and replaces it with a node located in Germany (granted this is a new country for the subnet, but it's yet another European node...🤷). 

@andrea or @bitdivine are you the guys to ask for this? Are you able to offer any clarity regarding the 'improve subnet decentralisation' element of this proposal?

-------------------------

Lorimer | 2024-08-09 23:26:00 UTC | #3

I think the situation is even more confusing with this similar proposal for `lhg73`  -> [Subnet Management - lhg73 (Application) - Developers - Internet Computer Developer Forum (dfinity.org)](https://forum.dfinity.org/t/subnet-management-lhg73-application/34055/2)

-------------------------

andrea | 2024-08-12 11:55:22 UTC | #4

[quote="Lorimer, post:2, topic:34056"]
@andrea or @bitdivine are you the guys to ask for this? Are you able to offer any clarity regarding the ‘improve subnet decentralisation’ element of this proposal?
[/quote]

I think when nodes are replaced, the proposals aims to improve on various decentralization metrics for the subnet, e.g. number of node providers, continents, jurisdictions, etc. Sometimes replacing multiple nodes makes it easier to improve some metrics, than replacing a single node. I don't actually know for this specific case, let me ping somebody that could share more details.

-------------------------

Lorimer | 2024-08-12 16:34:00 UTC | #5

Thanks @andrea, @SvenF gave a further explanation here (posting for reference) -> [New Node Provider Proposals - Roadmap - Internet Computer Developer Forum (dfinity.org)](https://forum.dfinity.org/t/new-node-provider-proposals/16643/462)

-------------------------

bitdivine | 2024-08-15 09:11:48 UTC | #6

I find that diagram much easier to look at.  Thanks for the blue!  (Maybe I'm just getting old and fuzzy-eyed but it helps :sweat_smile: )

-------------------------

Lorimer | 2024-08-15 16:33:35 UTC | #7

I think you're right, it was a great suggestion! This particular proposal was also interesting because a removed node was in the same location as an added node. Hopefully the other changes I made make this sort of situation clear (let me know if you have any other suggestions :) )

-------------------------

sat | 2024-08-16 13:41:35 UTC | #8

I just merged a change that should add more information to this type of proposals:

https://github.com/dfinity/dre/pull/736

-------------------------

Lorimer | 2024-08-16 16:15:36 UTC | #9

Awesome! Thanks @sat, I'm looking forward to seeing this in action

-------------------------

Lorimer | 2024-08-17 22:25:07 UTC | #10

[quote="Lorimer, post:2, topic:34056"]
There’s an open proposal for changing subnet membership
[/quote]
 ^ This proposal was rejected (DFINITY noticed that one of the proposed nodes was due to be decommissioned - the proposal for that decommissioning is now out -> [Proposal: 131758](https://dashboard.internetcomputer.org/proposal/131758)).

----

There's now a revised open proposal for this subnet -> [Proposal 131789](https://nns.ic0.app/proposal/?u=qoctq-giaaa-aaaaa-aaaea-cai&proposal=131789). Thanks again @sat, the proposal summary is now super informative! 🙌

I've independently verified the proposal claims below. As before, one node is down and is replaced by an up node by the same node provider in Japan. The other node change is intended to optimise subnet decentralisation coefficients. This optimisation appears to be mostly positive.

### Subnet node distance stats (distance between any 2 nodes in the subnet) ->

|            |Smallest Distance|Average Distance|Largest Distance|
|------------|-----------------|----------------|----------------|
|**EXISTING**|71.122 km|6513.222 km|16469.974 km|
|**PROPOSED**|71.122 km |**6215.817 km (-4.6%)** |16469.974 km |

This proposal slightly reduces decentralisation considered purely in terms of geographic distance (and therefore there's a slight theoretical reduction in localised disaster resilience). 👎

### Subnet characteristic counts ->

|            |Continents |Countries|Data Centers|Owners|Node Providers|
|------------|-----------|---------|------------|------|--------------|
|**EXISTING**|3|9|13|13|13|
|**PROPOSED**|3|**10 (+10%)**|13|13|13|

This proposal slightly increases the number of countries that constitute this subnet, improving decentralisation in terms of jurisdiction diversity. 👍

### Largest number of nodes with the same characteristic (e.g. continent, country, data center, etc.) ->

|            |Continent |Country|Data Center|Owner|Node Provider|
|------------|----------|-------|-----------|-----|-------------|
|**EXISTING**|7|4|1|1|1|
|**PROPOSED**|7 |**3  (-25%)**|1 |1 |1 |

See here for acceptable limits -> [Motion 125549](https://dashboard.internetcomputer.org/proposal/125549) (note that these are due for [a slight revision](https://forum.dfinity.org/t/adjustment-of-ic-target-topology-to-increase-subnet-size-of-fiduciary-and-ii-subnets/34210))

As far as I gather, this subnet is already in violation of the predefined maximum number of nodes within the same country, which is **supposed to be 2 for a 13 node subnet**.

This proposal brings this number closer to the acceptable limit 👍 (though I believe the outcome will still be in violation of the acceptable limit, *3 instead of 2*).

The above subnet information is illustrated below, followed by a node reference table:

<details>
        <summary>Map Description</summary>

 - **Red** marker represents a removed node (transparent center for overlap visibility)
 - **Green** marker represents an added node
 - **Blue** marker represents an unchanged node
 - Highlighted patches represent the country the above nodes sit within (red if the country is removed, green if added, otherwise grey)
 - **Light grey** markers with yellow borders are examples of unassigned nodes that would be viable candidates for joining the subnet according to formal decentralisation coefficients (so this proposal can be viewed in the context of alternative solutions that are not being used)

</details>

![image|690x278](upload://4zW79FdoUmfD7edHpP7TQpGOI2o.jpeg)


<details>
        <summary>Table</summary>

|   |Continent|Country|Data Center|Owner|Node Provider|Node|Status|
|---|---------|-------|-----------|-----|-------------|----|------|
|`---`|~~Asia~~|~~Japan~~|[~~Tokyo 3 (ty3)~~](https://dashboard.internetcomputer.org/center/ty3)|~~Equinix~~|[~~Starbase~~](https://dashboard.internetcomputer.org/provider/sixix-2nyqd-t2k2v-vlsyz-dssko-ls4hl-hyij4-y7mdp-ja6cj-nsmpf-yae)|[~~nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe~~](https://dashboard.internetcomputer.org/node/nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe)|[~~DOWN~~](https://dashboard.internetcomputer.org/node/nxayg-zna42-zpngn-tg6hw-heplm-xvfsb-bxyov-3qiix-aaavl-5pdev-uqe)|
|`---`|~~Americas~~|~~United States of America (the)~~|[~~Fremont (fm1)~~](https://dashboard.internetcomputer.org/center/fm1)|~~Hurricane Electric~~|[~~Mostly Wholesome, Inc.~~](https://dashboard.internetcomputer.org/provider/ou3o7-akyjc-ldwd5-anyjn-l2buz-cwhbg-nehlc-abkde-qtc7w-fozdi-hae)|[~~75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae~~](https://dashboard.internetcomputer.org/node/75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae)|[~~UP~~](https://dashboard.internetcomputer.org/node/75run-c7fya-7uoor-jzgtx-pwjc4-lfhyp-62p2w-2pnyv-amqh6-tdhji-rae)|
|`+++`|  Americas  |Canada|[Toronto 2 (to2)](https://dashboard.internetcomputer.org/center/to2)|Cyxtera|[Blockchain Development Labs](https://dashboard.internetcomputer.org/provider/7at4h-nhtvt-a4s55-jigss-wr2ha-ysxkn-e6w7x-7ggnm-qd3d5-ry66r-cae)|[2h6dm-k5h3n-nmqek-m5gty-yy3xq-a3atf-54its-biy25-ijh3c-xvit4-mae](https://dashboard.internetcomputer.org/node/2h6dm-k5h3n-nmqek-m5gty-yy3xq-a3atf-54its-biy25-ijh3c-xvit4-mae)|[UNASSIGNED](https://dashboard.internetcomputer.org/node/2h6dm-k5h3n-nmqek-m5gty-yy3xq-a3atf-54its-biy25-ijh3c-xvit4-mae)|
|`+++`|  Asia  |Japan|[Tokyo (ty1)](https://dashboard.internetcomputer.org/center/ty1)|Equinix|[Starbase](https://dashboard.internetcomputer.org/provider/sixix-2nyqd-t2k2v-vlsyz-dssko-ls4hl-hyij4-y7mdp-ja6cj-nsmpf-yae)|[ktqjk-r6yho-cqgxd-qaqqn-yhxvl-ez6ax-jk3n4-bfa2f-vprkh-eigf5-5qe](https://dashboard.internetcomputer.org/node/ktqjk-r6yho-cqgxd-qaqqn-yhxvl-ez6ax-jk3n4-bfa2f-vprkh-eigf5-5qe)|[UNASSIGNED](https://dashboard.internetcomputer.org/node/ktqjk-r6yho-cqgxd-qaqqn-yhxvl-ez6ax-jk3n4-bfa2f-vprkh-eigf5-5qe)|
|     |  Europe  |Belgium|[Brussels 2 (br2)](https://dashboard.internetcomputer.org/center/br2)|AtlasEdge|[Allusion](https://dashboard.internetcomputer.org/provider/rbn2y-6vfsb-gv35j-4cyvy-pzbdu-e5aum-jzjg6-5b4n5-vuguf-ycubq-zae)|[najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae](https://dashboard.internetcomputer.org/node/najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae)|[UP](https://dashboard.internetcomputer.org/node/najnj-to3ju-pl6pl-5yjlc-6vdqi-f7tht-qd7tt-fenyr-f3tjc-tfj37-uae)|
|     |  Europe  |Switzerland|[Geneva 2 (ge2)](https://dashboard.internetcomputer.org/center/ge2)|SafeHost|[Archery Blockchain SCSp](https://dashboard.internetcomputer.org/provider/7ryes-jnj73-bsyu4-lo6h7-lbxk5-x4ien-lylws-5qwzl-hxd5f-xjh3w-mqe)|[uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae](https://dashboard.internetcomputer.org/node/uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae)|[UP](https://dashboard.internetcomputer.org/node/uvyny-tt2f2-rb743-fk6ia-qn6ut-c3qyb-ob3aw-6qcvm-qbktr-pco7n-2ae)|
|     |  Europe  |Switzerland|[Zurich 5 (zh5)](https://dashboard.internetcomputer.org/center/zh5)|Green.ch|[Sygnum Bank](https://dashboard.internetcomputer.org/provider/6r5lw-l7db7-uwixn-iw5en-yy55y-ilbtq-e6gcv-g22r2-j3g6q-y37jk-jqe)|[c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe](https://dashboard.internetcomputer.org/node/c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe)|[UP](https://dashboard.internetcomputer.org/node/c2vrr-ynjrh-xturt-s77ah-a5efo-b726x-dgq4a-m7zdc-wvsa5-7ogz5-mqe)|
|     |  Europe  |Spain|[Madrid 3 (ma3)](https://dashboard.internetcomputer.org/center/ma3)|IPCore|[Vladyslav Popov](https://dashboard.internetcomputer.org/provider/3oqw6-vmpk2-mlwlx-52z5x-e3p7u-fjlcw-yxc34-lf2zq-6ub2f-v63hk-lae)|[oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae](https://dashboard.internetcomputer.org/node/oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae)|[UP](https://dashboard.internetcomputer.org/node/oiso5-hxkkc-elqlo-iyoqg-7oux4-5mscl-zkvoh-b2432-ohrir-b5fcm-gae)|
|     |  Europe  |Romania|[Bucharest (bu1)](https://dashboard.internetcomputer.org/center/bu1)|M247 |[Iancu Aurel](https://dashboard.internetcomputer.org/provider/i7dto-bgkj2-xo5dx-cyrb7-zkk5y-q46eh-gz6iq-qkgyc-w4qte-scgtb-6ae)|[7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe](https://dashboard.internetcomputer.org/node/7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe)|[UP](https://dashboard.internetcomputer.org/node/7agd5-pfc4g-rdozn-zajij-aax72-7jft2-rzw36-y3flc-xwt77-pjg5w-7qe)|
|     |  Asia  |Singapore|[Singapore (sg1)](https://dashboard.internetcomputer.org/center/sg1)|Telin|[OneSixtyTwo Digital Capital](https://dashboard.internetcomputer.org/provider/6nbcy-kprg6-ax3db-kh3cz-7jllk-oceyh-jznhs-riguq-fvk6z-6tsds-rqe)|[jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae](https://dashboard.internetcomputer.org/node/jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae)|[UP](https://dashboard.internetcomputer.org/node/jvqnq-6jnty-tr3ml-izvma-e5w6e-s3rfx-w4wir-mwcsf-x5yok-nc4uz-6ae)|
|     |  Europe  |Slovenia|[Ljubljana 2 (lj2)](https://dashboard.internetcomputer.org/center/lj2)|Anonstake|[Anonstake](https://dashboard.internetcomputer.org/provider/kos24-5xact-6aror-uofg2-tnvt6-dq3bk-c2c5z-jtptt-jbqvc-lmegy-qae)|[5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe](https://dashboard.internetcomputer.org/node/5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe)|[UP](https://dashboard.internetcomputer.org/node/5zqhj-66qn7-he3p5-76gnj-hlsvl-ajlt5-k356i-fgm4m-5it4c-6m5ag-7qe)|
|     |  Europe  |Sweden|[Stockholm 1 (sh1)](https://dashboard.internetcomputer.org/center/sh1)|Digital Realty|[DFINITY Operations SA](https://dashboard.internetcomputer.org/provider/bvcsg-3od6r-jnydw-eysln-aql7w-td5zn-ay5m6-sibd2-jzojt-anwag-mqe)|[ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae](https://dashboard.internetcomputer.org/node/ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae)|[UP](https://dashboard.internetcomputer.org/node/ozim4-dez5l-gk24c-m7phw-e6i32-c7vxe-m6you-mkprj-moxq2-fhtyw-uae)|
|     |  Americas  |United States of America (the)|[Atlanta 2 (at2)](https://dashboard.internetcomputer.org/center/at2)|Datasite|[BLP22, LLC](https://dashboard.internetcomputer.org/provider/sma3p-ivkif-hz7nu-ngmvq-ibnjg-nubke-zf6gh-wbnfc-2dlng-l3die-zqe)|[cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae](https://dashboard.internetcomputer.org/node/cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae)|[UP](https://dashboard.internetcomputer.org/node/cvic3-6mmjj-2zszr-mr727-im4l5-skwod-gzrg2-avd4i-bahw3-xyx3l-2ae)|
|     |  Americas  |United States of America (the)|[Jacksonville (jv1)](https://dashboard.internetcomputer.org/center/jv1)|Tierpoint|[9Yards Capital](https://dashboard.internetcomputer.org/provider/spp3m-vawt7-3gyh6-pjz5d-6zidf-up3qb-yte62-otexv-vfpqg-n6awf-lqe)|[7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae](https://dashboard.internetcomputer.org/node/7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae)|[UP](https://dashboard.internetcomputer.org/node/7ak5q-ev3ur-nmmup-rocyw-z2kxo-bqppk-vkj22-gicfw-6h37b-cpvmc-uae)|
|     |  Americas  |United States of America (the)|[Portland (pl1)](https://dashboard.internetcomputer.org/center/pl1)|Flexential|[87m Neuron, LLC](https://dashboard.internetcomputer.org/provider/eipr5-izbom-neyqh-s3ec2-52eww-cyfpg-qfomg-3dpwj-4pffh-34xcu-7qe)|[v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae](https://dashboard.internetcomputer.org/node/v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae)|[UP](https://dashboard.internetcomputer.org/node/v7xli-jnnol-am5py-5stvp-ucmul-5y4kn-yy4tu-34xee-mgfnu-y3hfg-xae)|

</details>

**I'm planning to adopt this proposal** as the improvements to subnet decentralisation (in terms of jurisdiction diversity) are more important than the slight increase in average node proximity. I do have some questions though. @SvenF would you be able to answer any of these? 🙏

- Am I correct in observing that the subnet is currently in violation of the predefined decentralisation coefficient relating to the maximum number of nodes that should belong to the same country? (and that the subnet will still be in violation of this even once this proposal passes, though it will be in a better position than it is now) 🧐

- There are plenty of viable nodes located in South Africa and Australia (illustrated on the map). Any of these would have improved the country coefficient, as well as increasing the average geographic distance between subnet nodes, as well as increasing the number of continents that the subnet is composed of. Am I missing something, or would one of these have potentially been a better choice of node to add to the subnet? 🤔

- When selecting nodes to add to a subnet to optimise decentralisation, is this done in a greedy fashion (considering just the subnet in question), or are redundancy requirements for other subnets also taken into account? 🤓

As a side note, there are two nodes (in Switzerland) in this subnet that are very close to one another, [roughly an hours drive apart](https://www.google.com/maps/dir/46.46190,+6.842470/46.948,7.44745/@46.7130255,6.7110931,10z/data=!3m1!4b1!4m6!4m5!1m3!2m2!1d6.84247!2d46.4619!1m0?entry=ttu) 🚗 (but of course these belong to different node providers and data centre owners, otherwise this would also be a violation of the decentralisation coefficients).

-------------------------

Lorimer | 2024-08-18 09:19:01 UTC | #11

> [2m    node_provider: 5.00 -> 5.00    (+0%)[0m
[2m      data_center: 5.00 -> 5.00    (+0%)[0m
[2mdata_center_owner: 5.00 -> 5.00    (+0%)[0m
[2m             city: 5.00 -> 5.00    (+0%)[0m
[2m          **country: 2.00 -> 2.00    (+0%)** [0m
[2m        continent: 1.00 -> 1.00    (+0%)[0m
.
[1;2m	Total: **3.83 -> 3.83  (+0%)** [0m

@sat shouldn't these coefficients be influenced by this proposal (as described in my post above), or have I misunderstood something? Are you able to share some pseudo code for the formula that generates these coefficients? I'm a little confused by the outcome of the country one.

-------------------------

sat | 2024-08-19 16:22:36 UTC | #12

[quote="Lorimer, post:10, topic:34056"]
As far as I gather, this subnet is already in violation of the predefined maximum number of nodes within the same country, which is **supposed to be 2 for a 13 node subnet**.

This proposal brings this number closer to the acceptable limit :+1: (though I believe the outcome will still be in violation of the acceptable limit, *3 instead of 2*).
[/quote]

The algorithm actually focuses on the Nakamoto coefficients across different features/dimensions. Here is what ChatGPT just generated when given the following prompt:
```
Can you please write pseudo code for calculating Nakamoto coefficients across 5 features/dimensions: "NodeProvider", "DataCenter", "DataCenterOwner", "City", "Country", "Continent"? This is for an Internet Computer subnet, and subnets on the IC have 3*f + 1 nodes, where f is the failure domain.
```

Generated code:
```python
function calculate_nakamoto_coefficients(nodes):
    # Dimensions to consider
    dimensions = ["NodeProvider", "DataCenter", "DataCenterOwner", "City", "Country", "Continent"]
    
    # Dictionary to store Nakamoto coefficient for each dimension
    nakamoto_coefficients = {}

    for dimension in dimensions:
        # Step 1: Group nodes by the current dimension
        groups = group_nodes_by_dimension(nodes, dimension)

        # Step 2: Calculate the number of nodes in each group
        group_sizes = []
        for group in groups:
            group_sizes.append(count_nodes_in_group(group))
        
        # Step 3: Sort groups by size in descending order
        group_sizes.sort(descending=True)

        # Step 4: Determine the minimum number of groups needed to control more than f nodes
        cumulative_nodes = 0
        f = (total_nodes(nodes) - 1) // 3
        for i in range(len(group_sizes)):
            cumulative_nodes += group_sizes[i]
            if cumulative_nodes > f:
                nakamoto_coefficients[dimension] = i + 1
                break

    return nakamoto_coefficients

function group_nodes_by_dimension(nodes, dimension):
    # Create a dictionary to group nodes by the specified dimension
    groups = {}
    for node in nodes:
        key = node[dimension]
        if key not in groups:
            groups[key] = []
        groups[key].append(node)
    return groups.values()

function count_nodes_in_group(group):
    # Return the number of nodes in the group
    return len(group)

function total_nodes(nodes):
    # Return the total number of nodes
    return len(nodes)

# Main function to calculate Nakamoto Coefficients across multiple dimensions
function main():
    nakamoto_coefficients = calculate_nakamoto_coefficient(nodes)

    # Return or print the Nakamoto coefficients
    return nakamoto_coefficients

# Example structure of a node in the nodes list
# node = {
#    "Continent": "Europe",
#    "Country": "Germany",
#    "City": "Berlin",
#    "Data Center": "DC1",
#    "Node Provider": "ProviderA",
#    "power": 100  # Power could be hash rate, stake, voting power, etc.
# }

# Example usage
nodes = [...]  # List of node dictionaries with the above structure
nakamoto_coefficients = main()
print(nakamoto_coefficients)
```

The actual code we use is at:

https://github.com/dfinity/dre/blob/main/rs/decentralization/src/nakamoto/mod.rs#L103-L176

And I also asked ChatGPT to compare the code it generated with the one in our code base, and check for bugs etc, and it answered the following:

[quote]
The Rust code you've provided is quite detailed and generally looks well-structured for calculating Nakamoto coefficients. However, there are a few areas where potential issues or improvements could be considered:

### 1. **Off-by-One Error in Nakamoto Calculation**

* In the `nakamoto` function, the loop breaks as soon as `sum_nodes` exceeds `max_malicious_nodes`. This is correct based on the logic you described, where you need to determine the minimum number of actors required to control more than one-third of the subnet. However, ensure that the logic for calculating `max_malicious_nodes` matches the subnet's consensus rules precisely. The comment suggests that `total_subnet_nodes / 3` is being used, which might be a simplification. Depending on the exact requirements (e.g., whether it's inclusive or exclusive of `f`), this could introduce an off-by-one error.
* **Check**: If the intention is that `f` is rounded down (i.e., integer division), then this is fine. However, if there's any nuance where rounding behavior needs to be different (e.g., always rounding up), this could lead to incorrect calculations. Consider using something like `let max_malicious_nodes = (total_subnet_nodes - 1) / 3;` to avoid potential off-by-one issues if the rules dictate this.

### 2. **Potential Overflow in Accumulation**

* In the `nakamoto` function, there is a comment regarding the use of `saturating_add` for `sum_nodes`. This is a good practice to avoid overflow, but you should double-check that using `usize` is sufficient for your domain. If the subnet is large, consider whether the size could exceed `usize::MAX` on your target platform. If there's a risk of overflow, you might want to consider a larger type like `u64`.

### 3. **Reverse Sorting and Accumulation Logic**

* The code sorts the `values` vector in descending order before starting the accumulation to determine the Nakamoto coefficient. This is appropriate, but ensure that the sorting is stable and that the function correctly handles cases where multiple actors might have the same count of nodes. Given the use of `sort_by`, this should be stable, but confirm if the input data might contain ties that could affect the final result.

### 4. **Handling Edge Cases**

* **Empty Input**: The function should correctly handle the case where `values` is empty, returning `(0, 0)` or some other meaningful result. If `total_subnet_nodes == 0`, `max_malicious_nodes` would also be zero, and the loop might behave unexpectedly.
* **Single Node**: If there's only one node, the function should return `(1, 1)` since compromising that single node would compromise the subnet.
* **Small Subnets**: If the subnet size is very small (e.g., 1, 2, or 3 nodes), the logic should be carefully checked to ensure it behaves as expected. For instance, with 3 nodes, `f = 0`, so the calculation might need special handling.

### 5. **Nakamoto Coefficient Interpretation**

* In the `nakamoto_calc` function, the results are used to calculate average linear and logarithmic scores. Ensure that these calculations match the expectations for how the Nakamoto coefficient is interpreted in your system. If `f` is small, the average calculations might not be very meaningful, so consider how these scores are interpreted and whether they need additional context or adjustments.

### 6. **Logarithmic Average Calculation**

* When calculating `avg_log2`, the check `if scores.values().all(|&v| v != 0 as f64)` ensures that all scores are non-zero. This is good for avoiding log of zero, but consider what should happen if any score is zero. Should the entire `avg_log2` be `None`, or should you exclude zero values from the logarithmic average calculation?

### Summary

The code seems compatible with the approach I initially described, and it's well-aligned with calculating Nakamoto coefficients across different dimensions. However, the key areas to review include the handling of edge cases, potential off-by-one errors, and ensuring that the calculations fit the exact consensus requirements of the Internet Computer subnet you're working with.
[/quote]

Based on that, I'd say the implementation is (relatively) okay.

> Am I correct in observing that the subnet is currently in violation of the predefined decentralisation coefficient relating to the maximum number of nodes that should belong to the same country? (and that the subnet will still be in violation of this even once this proposal passes, though it will be in a better position than it is now) :face_with_monocle:

@Lorimer The Nakamoto coefficient is calculated in a slightly different way. You need to sort countries based on the number of nodes in that country, and then keep summing up the countries until you get over 4 nodes. So in this case the calculation in the code is correct. The NC is 2 for the country, both before and after the replacement. You seem to have an off-by-one error in your analysis. But we are improving the node distribution with this proposal.

> There are plenty of viable nodes located in South Africa and Australia (illustrated on the map). Any of these would have improved the country coefficient, as well as increasing the average geographic distance between subnet nodes, as well as increasing the number of continents that the subnet is composed of. Am I missing something, or would one of these have potentially been a better choice of node to add to the subnet? :thinking:

These nodes would likely make some other coefficients / dimensions worse.

> When selecting nodes to add to a subnet to optimise decentralisation, is this done in a greedy fashion (considering just the subnet in question), or are redundancy requirements for other subnets also taken into account? :nerd_face:

We are doing in greedy fashion, but only 1 node at a time. What does that mean? Let's say that we need to add 2 nodes to a subnet. For each of the 2 nodes, we do:
* calculate the Nakamoto coefficients we would get for each of the ~500 nodes
* sort the candidates based on their Nakamoto
* pick the best Nakamoto
* find all candidates that have the best Nakamoto (may be 10-20 nodes with the same result)
* pick one of the best candidates - since [this PR](https://github.com/dfinity/dre/pull/734) we try to keep the same nodes if there is no improvement

HTH

-------------------------

Lorimer | 2024-08-19 22:14:33 UTC | #13

Thanks @sat, my last comment was a bit of a brain fart (and certainly was caused by an off-by-one error, in my head). I expected the country coefficient update to look like this,
- `e[2m country: 1.00 → 2.00 (+0%) e[0m`,  *rather than this,*
-  `e[2m country: 2.00 → 2.00 (+0%) e[0m`, 

because I was considering 4 malicious nodes to be needed to take down a subnet (such as the 4 in the US prior to this proposal executing), whereas 4 is of course the max number that can be tolerated (not the min number that cannot be tolerated). 

-----

**That being said**, I stand by the points that I raised in my main post. In order to comply with formal subnet limits, the Nakamato coefficient for the country characteristic **needs to be 3**. Hence **2 is too small** (requiring the nodes of only 2 countries to collude in order to theoretically attack the subnet). This is documented in more detail here ->

[quote="bjoernek, post:1, topic:23553"]
If each characteristic can appear up to twice in a given subnet, i.e. **subnet limit = 2**, the Nakamoto Coefficient will be reduced. In this case Nakamoto Coefficient NC_χ(N) is ceil(N/(2*3)). Taking the 13-node subnet as an example again, the **Nakamoto Coefficient becomes** ceil(13/6) = **3**.
[/quote]

[quote="bjoernek, post:1, topic:23553"]
Currently exhibiting the least decentralization, it seems logical to, at least initially, set a comparatively weaker decentralization target for the country characteristic. This would permit the same country to appear up to twice in any given subnet (**country subnet limit = 2**).
[/quote]

^ Given this, I would reiterate my point.

[quote="Lorimer, post:10, topic:34056"]
See here for acceptable limits → [Motion 125549](https://dashboard.internetcomputer.org/proposal/125549) (note that these are due for [a slight revision](https://forum.dfinity.org/t/adjustment-of-ic-target-topology-to-increase-subnet-size-of-fiduciary-and-ii-subnets/34210))

As far as I gather, this subnet is already in violation of the predefined maximum number of nodes within the same country, which is **supposed to be 2 for a 13 node subnet**.

This proposal brings this number closer to the acceptable limit :+1: (though I believe the outcome will still be in violation of the acceptable limit, *3 instead of 2*).
[/quote]

**I believe an additional proposal is needed** to get this subnet back within the acceptable limit according to the current and revised target IC topology (a limit of 2 nodes per country, meaning a minimum country Nakamoto coefficient of 3).

I wouldn't be surprised if other subnets have similar issues (I'll run some analysis when I get a chance, maybe tomorrow).

--------

Regarding the unassigned South Africa and Australia nodes, I was already filtering out nodes using the strictest of constraints (only returning unassigned nodes that did not share a single characteristic with the existing subnet nodes i.e. continent, country, node provider, data centre, owner).

These nodes could therefore only have had no effect or a positive impact on the Nakamoto coefficients of the subnet (not a negative impact). Here are a handful of example candidates:
- [4itjx-vyshn-cw55d-zywto-yston-7b5i7-upxxx-b2hhp-eajpv-lvygs-dae](https://dashboard.internetcomputer.org/node/4itjx-vyshn-cw55d-zywto-yston-7b5i7-upxxx-b2hhp-eajpv-lvygs-dae)
- [j3pcf-ielts-wwr24-73hhq-flvsq-d7yh3-ly5li-r6csx-5tczk-wkpc3-5ae](https://dashboard.internetcomputer.org/node/j3pcf-ielts-wwr24-73hhq-flvsq-d7yh3-ly5li-r6csx-5tczk-wkpc3-5ae)
- [qepub-grdmh-34oin-6eus4-r47jt-t7enf-g4yyz-fbvpt-isn4q-vdg7f-dae](https://dashboard.internetcomputer.org/node/qepub-grdmh-34oin-6eus4-r47jt-t7enf-g4yyz-fbvpt-isn4q-vdg7f-dae)
- [7fiyj-xjxkj-fjvbl-tl4rp-6xvg3-moow7-dwtyi-nsxeg-unw7n-ivshf-pqe](https://dashboard.internetcomputer.org/node/7fiyj-xjxkj-fjvbl-tl4rp-6xvg3-moow7-dwtyi-nsxeg-unw7n-ivshf-pqe)

[quote="sat, post:12, topic:34056"]
* calculate the Nakamoto coefficients we would get for each of the ~500 nodes
* **sort the candidates based on their Nakamoto**
* pick the best Nakamoto
[/quote]

**This approach is problematic**. For example, none of the unassigned nodes illustrated on the map that I rendered above would result in an improved Nakamoto coefficient by themself (for anything other than continent). This doesn't mean that they wouldn't improve decentralisation (essentially making it easier to improve the other Nakamoto coefficients with subsequent node swaps in the future).

**I think the crux of the issue** is that the Nakamoto coefficients are throwing away information because they're discretised. This is demonstrated by the fact that they weren't even affected by this proposal. I think it would probably make more sense to optimise for subnet limits directly, and therefore indirectly optimise for the Nakamoto coefficients (so that all information is available and considered during the optimisation procedure).

-------------------------

sat | 2024-08-20 11:47:38 UTC | #14

[quote="Lorimer, post:13, topic:34056"]
**I believe an additional proposal is needed** to get this subnet back within the acceptable limit according to the current and revised target IC topology (a limit of 2 nodes per country, meaning a minimum country Nakamoto coefficient of 3).
[/quote]

An empirical observation: we very rarely have enough nodes decentralized nodes to have a Nakamoto of 3 for country.


[quote="Lorimer, post:13, topic:34056"]
**I think the crux of the issue** is that the Nakamoto coefficients are throwing away information because they’re discretised. This is demonstrated by the fact that they weren’t even affected by this proposal. I think it would probably make more sense to optimise for subnet limits directly, and therefore indirectly optimise for the Nakamoto coefficients (so that all information is available and considered during the optimisation procedure).
[/quote]

We show the Nakamoto at the end, but we sort the candidates [based on other values](https://github.com/dfinity/dre/blob/main/rs/decentralization/src/nakamoto/mod.rs#L334-L462). So your suggestion (if I understood it correctly) is already done. If not, please send a PR :innocent:

-------------------------

Lorimer | 2024-08-20 18:14:27 UTC | #15

[quote="sat, post:14, topic:34056"]
We show the Nakamoto at the end, but we sort the candidates [based on other values ](https://github.com/dfinity/dre/blob/main/rs/decentralization/src/nakamoto/mod.rs#L334-L462). So your suggestion (if I understood it correctly) is already done. If not, please send a PR :innocent:
[/quote]

Thanks @sat, sounds good. I've not had much time to look at the code, but will plan to make some time to dive into it properly on the weekend.

[quote="sat, post:14, topic:34056"]
An empirical observation: **we very rarely have enough nodes** decentralized nodes to have a Nakamoto of 3 for country.
[/quote]

This sounds concerning given that a Nakamoto of 3 is the minimum permissible by the IC target topology, as I understand it.

I'm a little confused about how this scarcity can be the case though. [Here are the current unassigned replica nodes](https://ic-api.internetcomputer.org/api/v3/nodes?format=json&include_node_type=REPLICA&include_status=UNASSIGNED). I count,

* **804 unassigned nodes** in total
* **82 data centres** with unassigned nodes in total
* **84 node providers** with unassigned nodes in total
* **53 owners** with unassigned nodes in total
* **29 countries** with unassigned nodes in total
* **5 continents** with unassigned nodes in total

Am I missing something? I also count 31 nodes that don't share any of these characteristics with this subnet (I shared 4 of these in my previous message).

----

If I were to raise a `ChangeSubnetMembership` proposal myself to resolve this nonconformance, assuming that it achieves the desired Nakamoto coefficient across all dimensions for this subnet, would this be a proposal that DFINITY would be happy to accept?

-------------------------

SvenF | 2024-08-23 12:01:10 UTC | #16

Hi @Lorimer I think your observation is correct that there should be enough nodes to Nakamoto coefficient of 3 per country (since country limit is 2 for most subnets, which would mean 5 nodes need to collude to take over a 13 node subnet, which would be 2 in same country + another 2 in same country + any other node, which means Nakamoto coefficient is 3). Otherwise the IC target topology would not have been reached. 

But to support the statement of @sat, country is the most limiting factor in decentralization (there is much more variety in Node Providers, cities, data centers, and data center operators than countries), and spare nodes are not taken into account in the [optimization tool](https://forum.dfinity.org/t/ic-topology-node-diversification-part-ii/23553/9?u=svenf), so suboptimization by seeking the maximum decentralization for one subnet needs to be avoided.  

In the example above, swapping two nodes (for example adding one node from a Node Provider in South Africa, next to replacing the unhealthy node) is indeed interesting but does not change the nakamoto coefficient, as Sasa also indicated. With 3 (instead of 4) US nodes, and 2 nodes in Switzerland you still only need to have control over these two countries in order to take over the subnet. What is more interesting is the add *another* - third - node that replaces one American or Swiss node, then the country limit would bump of from 2 to 3. The current dre-tool can be run multiple times so that you can continuously improve each subnet, but for the two reasons above (country limit, and need for enough spare nodes) it's better to only do this increased optimization for the larger (i.e. high priority) subnets such as NNS, SNS, II and Fiduciary subnets. 

Please have a look at the dre-tooling and happy to hear your throughts.

-------------------------

Lorimer | 2024-08-23 18:33:44 UTC | #17

Thanks for your response @SvenF 

[quote="SvenF, post:16, topic:34056"]
for the two reasons above (country limit, and need for enough spare nodes) it’s better to only do this increased optimization for the larger (i.e. high priority) subnets such as NNS, SNS, II and Fiduciary subnets.
[/quote]

Do I understand correctly that you're saying there's an intentional plan to allow the smaller subnets to deviate from the formally proposed and voted in target IC topology, in order to give the larger subnets a better chance of meeting those same targets?

Doesn't this imply that the picture that's been painted for the current [IC Target Topology proposal](https://dashboard.internetcomputer.org/proposal/132136) is inaccurate and misleading, as this will lead to a scenario where the smaller subnets are even less likely to be able to meet their formally voted in topology target? (unless more node providers in more countries are onboarded)

-------------------------

Lorimer | 2024-08-24 16:37:15 UTC | #18

[quote="SvenF, post:16, topic:34056"]
The current dre-tool can be run multiple times so that you can continuously improve each subnet
[/quote]

I get the impression that the tool has issues when used in this way (given the payload problems that have occurred with these four recently submitted 'Change Subnet Membership' proposals - [5kdm2](https://forum.dfinity.org/t/subnet-management-5kdm2-application/33661/6), [mpubz](https://forum.dfinity.org/t/subnet-management-mpubz-application/33756/3), [tdb26](https://forum.dfinity.org/t/subnet-management-tdb26-nns/33663/12), [uzr34](https://forum.dfinity.org/t/subnet-management-uzr34-ii/33981/12)).

[quote="SvenF, post:16, topic:34056"]
Please have a look at the dre-tooling and happy to hear your throughts.
[/quote]

I'm quite interested in writing an alternative tool from the ground up using a different optimisation approach (non-greedy, non-linear, stochastically optimised using something like a simulated annealing algorithm - or whatever does a better job of avoiding local minima). I'm also interested in optimising for the fewest number of swaps required to meet arbitrary targets.

Does this sound like something that would be useful (I'd open source it of course)?

-------------------------

sat | 2024-08-26 09:11:43 UTC | #19

[quote="Lorimer, post:15, topic:34056"]
If I were to raise a `ChangeSubnetMembership` proposal myself to resolve this nonconformance, assuming that it achieves the desired Nakamoto coefficient across all dimensions for this subnet, would this be a proposal that DFINITY would be happy to accept?
[/quote]

Yes, absolutely. With this in mind, last week I've created a what-if subcommand in the DRE tool, which should allow you to easily play around and see what kind of an effect on decentralization would some replacements make.

https://dfinity.github.io/dre/subnet-decentralization-whatif.html

My suggestion would be to make sure you run this *before* submitting a proposal. Otherwise, you might get a rejection for something that seemed like a good action.

-------------------------

